# Load required libraries
suppressMessages({
    library(ggplot2)
    library(dplyr)
    library(gridExtra)
    library(viridis)
    library(plotly)
})

# Read trajectory data from CSV file generated by Fortran program
data <- read.csv("trajectory_data.csv", stringsAsFactors = FALSE)

# Data preprocessing and derived calculations
data$speed <- sqrt(data$velocity_x^2 + data$velocity_y^2)
data$kinetic_energy <- 0.5 * 0.145 * data$speed^2  # KE = 0.5*m*v^2, mass = 0.145 kg
data$potential_energy <- 0.145 * 9.81 * pmax(data$y_pos, 0)  # PE = mgh
data$total_energy <- data$kinetic_energy + data$potential_energy
data$angle_velocity <- atan2(data$velocity_y, data$velocity_x) * 180 / pi

# Calculate trajectory statistics
max_height <- max(data$y_pos)
max_range <- max(data$x_pos)
flight_time <- max(data$time)
impact_velocity <- tail(data$speed, 1)

# Print summary statistics
cat("=== Trajectory Analysis Results ===\n")
cat(sprintf("Maximum height: %.3f m\n", max_height))
cat(sprintf("Maximum range: %.3f m\n", max_range))
cat(sprintf("Flight time: %.3f s\n", flight_time))
cat(sprintf("Impact velocity: %.3f m/s\n", impact_velocity))
cat(sprintf("Initial energy: %.3f J\n", data$total_energy[1]))
cat(sprintf("Final energy: %.3f J\n", tail(data$total_energy, 1)))
cat(sprintf("Energy loss due to drag: %.3f J\n", data$total_energy[1] - tail(data$total_energy, 1)))

# Create comprehensive visualization plots

# Plot 1: Trajectory path with velocity color coding
p1 <- ggplot(data, aes(x = x_pos, y = y_pos)) +
    geom_path(aes(color = speed), size = 1.2) +
    scale_color_viridis_c(name = "Speed\n(m/s)") +
    labs(title = "Projectile Trajectory with Air Resistance",
         subtitle = "Color represents instantaneous velocity magnitude",
         x = "Horizontal Distance (m)",
         y = "Height (m)") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
          plot.subtitle = element_text(hjust = 0.5, size = 10)) +
    coord_equal()

# Plot 2: Velocity components over time
p2 <- ggplot(data) +
    geom_line(aes(x = time, y = velocity_x, color = "Horizontal"), size = 1) +
    geom_line(aes(x = time, y = velocity_y, color = "Vertical"), size = 1) +
    geom_line(aes(x = time, y = speed, color = "Total"), size = 1) +
    scale_color_manual(name = "Component", 
                       values = c("Horizontal" = "#1f77b4", 
                                  "Vertical" = "#ff7f0e", 
                                  "Total" = "#2ca02c")) +
    labs(title = "Velocity Components vs Time",
         x = "Time (s)",
         y = "Velocity (m/s)") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, size = 12, face = "bold"))

# Plot 3: Energy analysis
energy_data <- data %>%
    select(time, kinetic_energy, potential_energy, total_energy) %>%
    tidyr::gather(key = "energy_type", value = "energy", -time)

p3 <- ggplot(energy_data, aes(x = time, y = energy, color = energy_type)) +
    geom_line(size = 1) +
    scale_color_manual(name = "Energy Type",
                       values = c("kinetic_energy" = "#d62728",
                                  "potential_energy" = "#9467bd",
                                  "total_energy" = "#17becf"),
                       labels = c("Kinetic", "Potential", "Total")) +
    labs(title = "Energy Conservation Analysis",
         x = "Time (s)",
         y = "Energy (J)") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, size = 12, face = "bold"))

# Plot 4: Velocity angle over time
p4 <- ggplot(data, aes(x = time, y = angle_velocity)) +
    geom_line(color = "#ff7f0e", size = 1) +
    labs(title = "Velocity Angle vs Time",
         x = "Time (s)",
         y = "Velocity Angle (degrees)") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, size = 12, face = "bold"))

# Combine plots into a grid
combined_plot <- grid.arrange(p1, p2, p3, p4, ncol = 2, nrow = 2)

# Save plots to file
ggsave("trajectory_analysis.png", combined_plot, width = 14, height = 10, dpi = 300)

# Create interactive 3D trajectory plot (with time as z-axis for visualization)
if (requireNamespace("plotly", quietly = TRUE)) {
    interactive_plot <- plot_ly(data, 
                               x = ~x_pos, 
                               y = ~y_pos, 
                               z = ~time,
                               color = ~speed,
                               type = 'scatter3d',
                               mode = 'lines',
                               line = list(width = 8)) %>%
        layout(title = "Interactive Projectile Trajectory",
               scene = list(xaxis = list(title = "Horizontal Distance (m)"),
                           yaxis = list(title = "Height (m)"),
                           zaxis = list(title = "Time (s)")))
    
    # Save interactive plot
    htmlwidgets::saveWidget(interactive_plot, "interactive_trajectory.html")
    cat("Interactive plot saved as 'interactive_trajectory.html'\n")
}

# Perform comparative analysis: with vs without air resistance
# Calculate theoretical trajectory without air resistance
g <- 9.81
v0 <- 45.0
angle_rad <- 35.0 * pi / 180
vx0 <- v0 * cos(angle_rad)
vy0 <- v0 * sin(angle_rad)

# Generate theoretical data points
t_theoretical <- seq(0, 2 * vy0 / g, length.out = 1000)
x_theoretical <- vx0 * t_theoretical
y_theoretical <- vy0 * t_theoretical - 0.5 * g * t_theoretical^2
y_theoretical[y_theoretical < 0] <- 0

theoretical_data <- data.frame(
    time = t_theoretical,
    x_pos = x_theoretical,
    y_pos = y_theoretical,
    type = "No Air Resistance"
)

# Combine with actual data for comparison
actual_data_subset <- data %>%
    select(time, x_pos, y_pos) %>%
    mutate(type = "With Air Resistance")

comparison_data <- rbind(theoretical_data, actual_data_subset)

# Comparison plot
comparison_plot <- ggplot(comparison_data, aes(x = x_pos, y = y_pos, color = type)) +
    geom_path(size = 1.2) +
    scale_color_manual(values = c("With Air Resistance" = "#d62728", 
                                  "No Air Resistance" = "#2ca02c")) +
    labs(title = "Trajectory Comparison: With vs Without Air Resistance",
         x = "Horizontal Distance (m)",
         y = "Height (m)",
         color = "Simulation Type") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
          legend.position = "bottom") +
    coord_equal()

ggsave("trajectory_comparison.png", comparison_plot, width = 10, height = 8, dpi = 300)

# Statistical analysis and drag effect quantification
drag_effect_analysis <- data.frame(
    Parameter = c("Range Reduction", "Time Reduction", "Energy Loss Percentage"),
    Value = c(
        sprintf("%.1f%% (%.1f m)", 
                (max(x_theoretical) - max_range) / max(x_theoretical) * 100,
                max(x_theoretical) - max_range),
        sprintf("%.1f%% (%.3f s)", 
                (max(t_theoretical) - flight_time) / max(t_theoretical) * 100,
                max(t_theoretical) - flight_time),
        sprintf("%.1f%% (%.3f J)",
                (data$total_energy[1] - tail(data$total_energy, 1)) / data$total_energy[1] * 100,
                data$total_energy[1] - tail(data$total_energy, 1))
    )
)

print(drag_effect_analysis)

# Export processed data for further analysis
write.csv(data, "processed_trajectory_data.csv", row.names = FALSE)

cat("\n=== Analysis Complete ===\n")
cat("Generated files:\n")
cat("- trajectory_analysis.png (4-panel analysis plot)\n")
cat("- trajectory_comparison.png (with/without drag comparison)\n") 
cat("- processed_trajectory_data.csv (enhanced dataset)\n")
cat("- interactive_trajectory.html (3D interactive plot)\n")